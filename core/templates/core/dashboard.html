{% extends "base.html" %}
{% block content %}

{% if batch %}
<style>
    :root {
        --primary-navy: #1a237e;
        --accent-purple: #4e46e5;
        --border-light: #E5E7EB;
        --text-muted: #64748b;
        --success-green: #059669;
        --error-red: #dc2626;
        --running-blue: #2563eb;
    }

    /* Enterprise Scale Container */
    .dashboard-container {
        padding: 40px 5%; /* Adjusted from 60px 8% */
        background-color: #fcfcfd;
        min-height: 100vh;
    }

    .dashboard-header { margin-bottom: 30px; }
    .dashboard-header h1 { 
        font-size: 2.2rem; /* Reduced from 3.5rem */
        font-weight: 900; 
        color: #1e293b; 
        margin-bottom: 8px; 
        letter-spacing: -0.5px;
    }
    .dashboard-header .batch-id { 
        color: #2563eb; 
        font-weight: 800; 
        font-size: 1rem; /* Reduced from 1.4rem */
    }

    /* REAL-TIME DYNAMIC ALERT */
    .status-alert {
        padding: 14px 24px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 30px;
        font-weight: 700;
        font-size: 1rem; /* Reduced from 1.3rem */
        transition: all 0.4s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }

    .status-running { background-color: var(--running-blue); color: white; }
    .status-success { background-color: var(--success-green); color: white; }
    .status-error { background-color: var(--error-red); color: white; }

    .spinner-custom {
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* AI Analysis Card */
    .ai-analysis-card {
        background: white;
        border: 1px solid var(--border-light);
        border-radius: 16px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.04);
    }
    .ai-analysis-card h3 { 
        font-size: 0.9rem; /* Reduced from 1.4rem */
        font-weight: 900; 
        color: #475569; 
        text-transform: uppercase; 
        margin-bottom: 15px; 
        letter-spacing: 1px;
    }
    .ai-content { 
        line-height: 1.6; 
        color: #334155; 
        font-size: 1rem; /* Reduced from 1.45rem */
    }

    /* KPI Grid */
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 30px;
    }
    .kpi-card {
        background: white;
        border: 1px solid var(--border-light);
        padding: 20px;
        border-radius: 16px;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }
    .kpi-card .value { 
        font-size: 1.8rem; /* Reduced from 3.5rem */
        font-weight: 900; 
        color: #1e293b; 
        line-height: 1; 
    }

    .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
    .chart-card { background: white; border: 1px solid var(--border-light); border-radius: 16px; padding: 25px; }
    .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .chart-header h4 { 
        font-size: 1rem; /* Reduced from 1.3rem */
        font-weight: 900; 
        color: #475569; 
        margin: 0; 
    }

    /* Scaled Table */
    .products-table-card {
        background: white;
        border: 1px solid var(--border-light);
        border-radius: 16px;
        overflow: hidden;
        margin-bottom: 40px;
        box-shadow: 0 15px 50px rgba(0,0,0,0.05);
    }
    .table-header { padding: 25px 35px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--border-light); }
    .table-header h3 { font-size: 1.2rem; margin: 0; }
    .data-table { width: 100%; border-collapse: collapse; }
    .data-table th { 
        background: #fcfcfd; 
        padding: 15px 30px; 
        text-align: left; 
        font-size: 0.85rem; /* Adjusted from 1.3rem */
        font-weight: 800; 
        color: #64748b; 
        border-bottom: 2px solid var(--border-light); 
        text-transform: uppercase; 
    }
    .data-table td { 
        padding: 20px 30px; 
        font-size: 0.95rem; /* Adjusted from 1.4rem */
        border-bottom: 1px solid #f1f5f9; 
        vertical-align: middle; 
    }
    
    .product-thumb { width: 60px; height: 60px; object-fit: contain; border-radius: 8px; border: 2px solid var(--border-light); }
    .btn-export { 
        padding: 10px 20px; 
        border: 2px solid var(--border-light); 
        border-radius: 10px; 
        font-size: 0.9rem; 
        font-weight: 800; 
        color: #475569; 
        text-decoration: none; 
    }
</style>

<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>Scraping Dashboard</h1>
        <div class="batch-id">Batch ID: {{ batch.id }}</div>
    </div>

    <div id="realTimeAlert" class="status-alert" style="display: none;">
        <div id="statusIcon"></div>
        <span id="statusText"></span>
    </div>

    <div class="ai-analysis-card">
        <h3>Strategic Market Synthesis</h3>
        <div class="ai-content">
            {% if batch.ai_summary %}{{ batch.ai_summary|linebreaks }}{% else %}Analysis will be generated upon completion...{% endif %}
        </div>
    </div>

    <div class="kpi-grid">
        <div class="kpi-card"><div><span class="label" style="font-weight:800; color:var(--text-muted); font-size:0.9rem; display:block; margin-bottom:8px;">Total</span><div class="value" id="kpiCount">{{ stats.count|default:0 }}</div></div><i class="fa-solid fa-boxes-stacked" style="font-size: 1.5rem; color: #cbd5e1;"></i></div>
        <div class="kpi-card"><div><span class="label" style="font-weight:800; color:var(--text-muted); font-size:0.9rem; display:block; margin-bottom:8px;">Avg. Price</span><div class="value">JOD {{ stats.avg|default:"0.00" }}</div></div><i class="fa-solid fa-receipt" style="font-size: 1.5rem; color: #cbd5e1;"></i></div>
        <div class="kpi-card"><div><span class="label" style="font-weight:800; color:var(--text-muted); font-size:0.9rem; display:block; margin-bottom:8px;">Median</span><div class="value">JOD {{ stats.median|default:"0" }}</div></div><div style="width: 25px; height: 25px;"><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 20 20" fill="none"><path d="M0.3125 7.09907V13.5514C0.3125 14.2644 0.871941 14.8419 1.56265 14.8419C2.25335 14.8419 2.8128 14.2644 2.8128 13.5514V7.09907C2.8128 6.38608 2.25335 5.80859 1.56265 5.80859C0.871941 5.80859 0.3125 6.38608 0.3125 7.09907Z" fill="#1e293b"/><path d="M5.9375 1.29048V13.55C5.9375 14.263 6.49694 14.8405 7.18765 14.8405C7.87835 14.8405 8.4378 14.263 8.4378 13.55V1.29048C8.4378 0.577488 7.87835 0 7.18765 0C6.49694 0 5.9375 0.577488 5.9375 1.29048Z" fill="#1e293b"/><path d="M12.8126 8.39062C12.1219 8.39062 11.5625 8.96811 11.5625 9.6811V13.5525C11.5625 14.2655 12.1219 14.843 12.8126 14.843C13.5034 14.843 14.0628 14.2655 14.0628 13.5525V9.6811C14.0628 8.96811 13.5034 8.39062 12.8126 8.39062Z" fill="#1e293b"/><path d="M18.4376 3.22656C17.7469 3.22656 17.1875 3.80405 17.1875 4.51704V13.5504C17.1875 14.2634 17.7469 14.8408 18.4376 14.8408C19.1284 14.8408 19.6878 14.2634 19.6878 13.5504V4.51704C19.6878 3.80405 19.1284 3.22656 18.4376 3.22656Z" fill="#1e293b"/><path d="M1.25015 19.9989H18.7522C19.4429 19.9989 20.0024 19.4214 20.0024 18.7084C20.0024 17.9955 19.4429 17.418 18.7522 17.418H1.25015C0.559441 17.418 0 17.9955 0 18.7084C0 19.4214 0.559441 19.9989 1.25015 19.9989Z" fill="#1e293b"/></svg></div></div>
        <div class="kpi-card"><div><span class="label" style="font-weight:800; color:var(--text-muted); font-size:0.9rem; display:block; margin-bottom:8px;">Range</span><div class="value">{{ stats.min|default:0 }} - {{ stats.max|default:0 }}</div></div><i class="fa-solid fa-tags" style="font-size: 1.5rem; color: #cbd5e1;"></i></div>
    </div>

    <div class="charts-row">
        <div class="chart-card"><div class="chart-header"><h4>Price Trend Overview</h4></div><canvas id="priceChart" height="200"></canvas></div>
        <div class="chart-card"><div class="chart-header"><h4>Market Distribution</h4></div><canvas id="rangeChart" height="200"></canvas></div>
    </div>

    <div class="products-table-card">
        <div class="table-header"><h3>Analyzed Datasets</h3><div style="display:flex; gap:15px;"><a href="{% url 'export_csv' batch.id %}" class="btn-export">Export CSV</a><a href="{% url 'export_json' batch.id %}" class="btn-export">Export JSON</a></div></div>
        <table class="data-table">
            <thead><tr><th>Thumbnail</th><th>Product Title</th><th>Price</th><th>Currency</th><th>Reference</th></tr></thead>
            <tbody>
                {% for product in products %}
                <tr class="product-row">
                    <td><img src="{{ product.image_url }}" class="product-thumb" onerror="this.src='https://placehold.co/150?text=No+Image'"></td>
                    <td><div style="font-weight: 800;">{{ product.title|truncatechars:60 }}</div></td>
                    <td style="font-weight: 900; color: var(--primary-navy);">{{ product.price|default:"â€”" }}</td>
                    <td style="font-weight: 700; color: var(--text-muted);">JOD</td>
                    <td><a href="{{ product.product_url }}" target="_blank" style="color: #2563eb; font-weight: 800; text-decoration: none;">View Detail</a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const chartLabels = JSON.parse("{{ chart_labels|escapejs }}");
    const chartPrices = JSON.parse("{{ chart_prices|escapejs }}");
    const rangeLabels = JSON.parse("{{ range_labels|escapejs }}");
    const rangeData = JSON.parse("{{ range_data|escapejs }}");

    if (chartLabels.length > 0) {
        new Chart(document.getElementById('priceChart'), {
            type: 'bar',
            data: { labels: chartLabels, datasets: [{ label: 'Price', data: chartPrices, backgroundColor: '#4338ca', borderRadius: 8 }] },
            options: { 
                responsive: true, 
                plugins: { legend: { display: false } },
                scales: { 
                    y: { ticks: { font: { size: 12, weight: 'bold' } } }, 
                    x: { ticks: { font: { size: 11, weight: 'bold' } } } 
                }
            }
        });

        new Chart(document.getElementById('rangeChart'), {
            type: 'doughnut',
            data: { labels: rangeLabels, datasets: [{ data: rangeData, backgroundColor: ['#1e1b4b', '#3730a3', '#6366f1', '#a5b4fc'], borderWidth: 3, borderColor: '#ffffff' }] },
            options: { 
                responsive: true, 
                cutout: '70%', 
                plugins: { 
                    legend: { 
                        position: 'bottom', 
                        labels: { usePointStyle: true, padding: 20, font: { size: 14, weight: '700' } } 
                    } 
                } 
            }
        });
    }

    // REAL-TIME STATUS LOGIC
    const batchId = "{{ batch.id }}";
    const alertBox = document.getElementById('realTimeAlert');
    const statusIcon = document.getElementById('statusIcon');
    const statusText = document.getElementById('statusText');

    async function pollStatus() {
        try {
            const res = await fetch(`/batch/${batchId}/status/`);
            const data = await res.json();
            const job = data.jobs[0];
            if (!job) return;

            const status = job.status.toUpperCase();
            const apiCount = data.product_count || 0;
            const domCount = document.querySelectorAll('.product-row').length;
            const finalCount = Math.max(apiCount, domCount);

            if (status === 'RUNNING' || status === 'PENDING') {
                alertBox.style.display = 'flex';
                alertBox.className = 'status-alert status-running';
                statusIcon.className = 'spinner-custom';
                statusText.textContent = `Scraping in progress... Found ${finalCount} products so far.`;
            } else if (status === 'DONE') {
                alertBox.style.display = 'flex';
                alertBox.className = 'status-alert status-success';
                statusIcon.className = 'fa-solid fa-circle-check';
                statusText.textContent = `Success! Saved Products from this automated scrape.`;
                if (domCount === 0 && apiCount > 0) setTimeout(() => location.reload(), 1500);
                clearInterval(pollInterval);
            } else if (status === 'ERROR' || status === 'FAILED') {
                alertBox.style.display = 'flex';
                alertBox.className = 'status-alert status-error';
                statusIcon.className = 'fa-solid fa-circle-xmark';
                statusText.textContent = `Error: The scraping process encountered a failure.`;
                clearInterval(pollInterval);
            }
        } catch (err) { console.error(err); }
    }
    const pollInterval = setInterval(pollStatus, 3000);
    pollStatus();
</script>

{% endif %}
{% endblock %}